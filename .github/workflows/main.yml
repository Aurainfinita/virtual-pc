name: CI

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download ngrok
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-windows-amd64.zip" -OutFile "ngrok.zip"
          Expand-Archive ngrok.zip -DestinationPath .
          .\ngrok.exe version

      - name: Authenticate ngrok
        shell: pwsh
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          .\ngrok.exe config add-authtoken "$env:NGROK_AUTH_TOKEN"

      - name: Enable RDP and set password
        shell: pwsh
        run: |
          net user runneradmin "SenhaForte123!"
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          netsh advfirewall firewall set rule group="Remote Desktop" new enable=Yes

      - name: Start ngrok TCP tunnel 3389
        shell: pwsh
        run: |
          .\ngrok.exe tcp 3389 --log=stdout > ngrok.log 2>&1 &
          Start-Sleep -Seconds 10
          Get-Content ngrok.log

      - name: Show ngrok TCP URL
        shell: pwsh
        run: |
          $maxTries = 10
          $try = 0
          $ok = $false
          do {
            try {
              $tunnels = Invoke-RestMethod -Uri "http://127.0.0.1:4040/api/tunnels"
              $ok = $true
            } catch {
              Write-Host "ngrok ainda não respondeu, tentando de novo..."
              Start-Sleep -Seconds 3
              $try++
            }
          } while (-not $ok -and $try -lt $maxTries)

          if (-not $ok) {
            Write-Error "Não foi possível conectar à API do ngrok em 127.0.0.1:4040."
            exit 1
          }

          $tcp = $tunnels.tunnels | Where-Object { $_.proto -eq "tcp" }
          if (-not $tcp) {
            Write-Error "Nenhum túnel TCP encontrado no ngrok."
          } else {
            $url = $tcp.public_url
            Write-Host "======================================"
            Write-Host "  NGROK TCP RDP: $url"
            Write-Host "  Usuario: runneradmin"
            Write-Host "  Senha:   SenhaForte123!"
            Write-Host "======================================"
          }

      - name: Keep session for 20 minutes
        shell: pwsh
        run: |
          Write-Host "Mantendo a VM online por 20 minutos para você conectar via RDP..."
          Start-Sleep -Seconds 1200
